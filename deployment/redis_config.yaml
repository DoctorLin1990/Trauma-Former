# Redis Configuration for Trauma-Former Digital Twin
# Production-grade configuration for clinical deployment

# Redis version
version: '6.2'

# General configuration
redis:
  # Network configuration
  bind: "0.0.0.0"  # Bind to all interfaces
  port: 6379
  protected-mode: "no"  # Disable for containerized deployment
  tcp-backlog: 511
  timeout: 0
  tcp-keepalive: 300
  
  # Security
  requirepass: "${REDIS_PASSWORD:-TraumaFormerSecure123!}"  # Set via environment variable
  masterauth: ""  # For replication
  
  # Performance tuning
  maxmemory: "4gb"  # Maximum memory usage
  maxmemory-policy: "allkeys-lru"  # LRU eviction policy
  maxmemory-samples: 5
  lazyfree-lazy-eviction: "yes"
  lazyfree-lazy-expire: "yes"
  lazyfree-lazy-server-del: "yes"
  
  # Persistence
  save:  # Save snapshots
    - "900 1"    # Save if 1 key changed in 900 seconds
    - "300 10"   # Save if 10 keys changed in 300 seconds
    - "60 10000" # Save if 10000 keys changed in 60 seconds
  stop-writes-on-bgsave-error: "yes"
  rdbcompression: "yes"
  rdbchecksum: "yes"
  dbfilename: "dump.rdb"
  dir: "/data"
  
  # Append-only file (AOF) persistence
  appendonly: "yes"
  appendfilename: "appendonly.aof"
  appendfsync: "everysec"  # Balance between performance and durability
  no-appendfsync-on-rewrite: "no"
  auto-aof-rewrite-percentage: 100
  auto-aof-rewrite-min-size: "64mb"
  aof-load-truncated: "yes"
  aof-use-rdb-preamble: "yes"
  
  # Replication (for high availability)
  replica-serve-stale-data: "yes"
  replica-read-only: "yes"
  repl-diskless-sync: "no"
  repl-diskless-sync-delay: 5
  repl-disable-tcp-nodelay: "no"
  replica-priority: 100
  
  # Security
  rename-command:
    FLUSHDB: ""    # Disable FLUSHDB for security
    FLUSHALL: ""   # Disable FLUSHALL for security
    CONFIG: ""     # Disable CONFIG for security
    SHUTDOWN: ""   # Disable SHUTDOWN for security
  
  # Client configuration
  maxclients: 10000
  client-output-buffer-limit:
    normal: "0 0 0"
    replica: "256mb 64mb 60"
    pubsub: "32mb 8mb 60"
  
  # Lua scripting
  lua-time-limit: 5000
  
  # Slow log
  slowlog-log-slower-than: 10000  # microseconds
  slowlog-max-len: 128
  
  # Latency monitoring
  latency-monitor-threshold: 100  # milliseconds
  
  # Event notification
  notify-keyspace-events: ""

# Redis Time-Series Module configuration (if used)
timeseries:
  enabled: true
  retention: "30d"  # Keep 30 days of time-series data
  chunk_size: "4096"
  duplicate_policy: "last"  # Keep last value on duplicate timestamps
  
# Custom Redis keys for Trauma-Former
trauma_former_keys:
  # Patient state keys (pattern: patient:{patient_id}:state)
  patient_state_prefix: "patient:"
  patient_state_ttl: 86400  # 24 hours in seconds
  
  # Patient history keys (pattern: patient:{patient_id}:history:{timestamp})
  patient_history_prefix: "history:"
  patient_history_ttl: 2592000  # 30 days in seconds
  
  # Model predictions keys (pattern: prediction:{patient_id}:{timestamp})
  prediction_prefix: "prediction:"
  prediction_ttl: 604800  # 7 days in seconds
  
  # Alert keys (pattern: alert:{patient_id}:{alert_id})
  alert_prefix: "alert:"
  alert_ttl: 172800  # 48 hours in seconds
  
  # System monitoring keys
  system_stats_key: "system:stats"
  system_stats_ttl: 3600  # 1 hour in seconds
  
  # Model performance metrics
  metrics_prefix: "metrics:"
  metrics_ttl: 86400  # 24 hours in seconds

# Memory optimization for clinical data
memory_optimization:
  # Use smaller encodings where possible
  hash-max-ziplist-entries: 512
  hash-max-ziplist-value: 64
  list-max-ziplist-size: -2
  list-compress-depth: 0
  set-max-intset-entries: 512
  zset-max-ziplist-entries: 128
  zset-max-ziplist-value: 64
  hll-sparse-max-bytes: 3000
  
  # Active defragmentation
  activedefrag: "yes"
  active-defrag-ignore-bytes: "100mb"
  active-defrag-threshold-lower: 10
  active-defrag-threshold-upper: 100
  active-defrag-cycle-min: 5
  active-defrag-cycle-max: 75
  active-defrag-max-scan-fields: 1000

# Cluster configuration (for scalability)
cluster:
  enabled: false  # Set to true for production cluster
  nodes:
    - "redis-1:6379"
    - "redis-2:6379"
    - "redis-3:6379"
  
  cluster-config-file: "nodes.conf"
  cluster-node-timeout: 15000
  cluster-replica-validity-factor: 10
  cluster-migration-barrier: 1
  cluster-require-full-coverage: "yes"

# Monitoring and metrics
monitoring:
  # Prometheus metrics endpoint
  prometheus_enabled: true
  prometheus_port: 9121
  
  # Health checks
  health_check_interval: 30  # seconds
  health_check_timeout: 5    # seconds
  
  # Performance metrics collection
  collect_metrics: true
  metrics_interval: 60  # seconds

# Backup configuration
backup:
  enabled: true
  schedule: "0 2 * * *"  # Daily at 2 AM
  retention_days: 7
  backup_dir: "/backups"
  
  # RDB backup configuration
  rdb_backup:
    enabled: true
    compression: "gzip"
    
  # AOF backup configuration
  aof_backup:
    enabled: true
    rewrite_before_backup: true

# Security configuration
security:
  # TLS configuration (if enabled)
  tls:
    enabled: false
    port: 6380
    cert_file: "/ssl/redis.crt"
    key_file: "/ssl/redis.key"
    ca_cert_file: "/ssl/ca.crt"
    auth_clients: "yes"
  
  # ACL (Access Control List)
  aclfile: "/etc/redis/users.acl"
  
  # Connection security
  bind_source_addr: ""
  supervised: "systemd"  # Use systemd for process supervision
  
  # Firewall rules (applied outside Redis)
  allowed_ips:
    - "10.0.0.0/8"     # Hospital network
    - "172.16.0.0/12"  # Docker network
    - "192.168.0.0/16" # Local network

# Logging configuration
logging:
  loglevel: "notice"  # Options: debug, verbose, notice, warning
  logfile: "/var/log/redis/redis-server.log"
  syslog-enabled: "no"
  syslog-ident: "redis"
  syslog-facility: "local0"
  
  # Slow query logging
  slowlog_enabled: true
  slowlog_file: "/var/log/redis/slowlog.log"

# Performance tuning for healthcare workload
performance:
  # Network performance
  tcp-keepalive: 300
  tcp-backlog: 511
  
  # Memory performance
  maxmemory-policy: "allkeys-lru"
  maxmemory-samples: 10
  
  # I/O performance
  io-threads: 4  # Number of I/O threads
  io-threads-do-reads: "yes"
  
  # AOF performance
  aof-rewrite-incremental-fsync: "yes"
  
  # RDB performance
  rdb-save-incremental-fsync: "yes"

# Trauma-Former specific optimizations
trauma_former_optimizations:
  # Patient data schema
  patient_data_schema:
    vital_signs:
      encoding: "hash"  # Use Redis Hash for vital signs
      compression: "gzip"  # Compress historical data
      ttl: 86400  # 24 hours
    
    predictions:
      encoding: "sorted_set"  # Use Sorted Set for time-series predictions
      score_field: "timestamp"
      ttl: 604800  # 7 days
    
    alerts:
      encoding: "stream"  # Use Redis Stream for alert events
      max_length: 1000  # Keep last 1000 alerts
      ttl: 172800  # 48 hours
  
  # Cache optimization
  cache_strategy:
    l1_cache: "in_memory"  # Recent data in memory
    l2_cache: "ssd"  # Historical data on SSD
    cache_size: "2gb"
    eviction_policy: "lru"
  
  # Query optimization
  query_optimization:
    index_patient_data: true
    index_timestamps: true
    use_secondary_indexes: true

# Environment variables (for Docker/Kubernetes)
environment:
  REDIS_PASSWORD: "${REDIS_PASSWORD}"
  REDIS_PORT: "${REDIS_PORT:-6379}"
  REDIS_DATABASES: "16"
  REDIS_MAXMEMORY: "${REDIS_MAXMEMORY:-4gb}"
  REDIS_MAXMEMORY_POLICY: "${REDIS_MAXMEMORY_POLICY:-allkeys-lru}"
  
  # Timezone
  TZ: "Asia/Shanghai"
  
  # Locale
  LANG: "en_US.UTF-8"
  LC_ALL: "en_US.UTF-8"

# Health check configuration
health_check:
  # Liveness probe
  liveness:
    command: ["redis-cli", "ping"]
    interval: 30
    timeout: 5
    retries: 3
    start_period: 60
  
  # Readiness probe
  readiness:
    command: ["redis-cli", "ping"]
    interval: 10
    timeout: 5
    retries: 3
  
  # Startup probe
  startup:
    command: ["redis-cli", "ping"]
    interval: 5
    timeout: 5
    retries: 30

# Resource limits
resources:
  # CPU limits
  cpu:
    requests: "1000m"
    limits: "2000m"
  
  # Memory limits
  memory:
    requests: "2Gi"
    limits: "4Gi"
  
  # Storage
  storage:
    size: "10Gi"
    storage_class: "ssd"
    access_modes: ["ReadWriteOnce"]

# Notes for deployment
notes: |
  This Redis configuration is optimized for the Trauma-Former Digital Twin system.
  
  Key considerations for clinical deployment:
  1. Security: Password protection and TLS are essential
  2. Performance: Optimized for time-series medical data
  3. Reliability: AOF and RDB persistence for data durability
  4. Scalability: Cluster configuration for high availability
  
  Environment variables should be set via Kubernetes Secrets or Docker secrets.
  
  For production deployment:
  - Enable TLS encryption
  - Set strong passwords via environment variables
  - Configure proper backup strategies
  - Monitor performance metrics
  - Set appropriate resource limits
  
  This configuration assumes Redis 6.2+. For older versions, some options may not be available.